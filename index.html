<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rsbalo - Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø¯Ø±Ø§Ø³Ø© ÙˆØ§Ù„Ù†Ø·Ù‚ Ø§Ù„ØµÙˆØªÙŠ</title>
    <!-- ØªØ¶Ù…ÙŠÙ† Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Cairo:wght@200..1000&display=swap');

        body {
            font-family: 'Cairo', 'Inter', sans-serif;
            background-color: #f7f7f7;
        }

        /* ØªØ®ØµÙŠØµ Ù…Ø¤Ø´Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø© */
        .typing-dot {
            animation: pulse 1s infinite;
            background-color: #9ca3af; /* Ø±Ù…Ø§Ø¯ÙŠ Ù…ØªÙˆØ³Ø· */
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin: 0 2px;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(0.8); opacity: 0.5; }
            50% { transform: scale(1); opacity: 1; }
        }

        /* ØªØ®ØµÙŠØµ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± */
        #chat-window::-webkit-scrollbar {
            width: 8px;
        }

        #chat-window::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 4px;
        }

        #chat-window::-webkit-scrollbar-track {
            background-color: #f7f7f7;
        }
        
        /* ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        .button-effect {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        }
        .button-effect:hover {
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
            transform: translateY(-1px);
        }
        .button-effect:active {
            box-shadow: none;
            transform: translateY(0);
        }

        /* ØªØ£Ø«ÙŠØ± Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ù„Ù„Ù…ÙØªØ§Ø­ */
        .api-input-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding-top 0.3s ease-out, padding-bottom 0.3s ease-out;
        }
        .api-input-container.open {
            max-height: 150px; /* Ø²ÙŠØ§Ø¯Ø© Ù„ÙŠØªØ³Ø¹ Ø§Ù„Ø²Ø± ÙˆØ§Ù„Ù…ÙØªØ§Ø­ */
            padding-top: 1rem;
            padding-bottom: 1rem;
        }
        
        .save-btn-success {
            background-color: #10b981; /* Ø²Ù…Ø±Ø¯ÙŠ 500 */
            color: white;
            opacity: 1 !important;
        }
        .save-btn-success:hover {
            background-color: #059669; /* Ø²Ù…Ø±Ø¯ÙŠ 600 */
        }
    </style>
</head>
<body class="flex flex-col h-screen antialiased">
    <!-- Ø±Ø£Ø³ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙˆÙˆØ§Ø¬Ù‡Ø© Ø¥Ø¯Ø®Ø§Ù„ API -->
    <header class="bg-indigo-700 text-white shadow-xl">
        <div class="p-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold">Rsbalo - Ø±Ø³Ø¨Ø§Ù„Ùˆ: Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ</h1>
            <!-- Ø²Ø± ØªØ¨Ø¯ÙŠÙ„ API Key -->
            <button id="api-key-toggle" class="p-2 rounded-full hover:bg-indigo-600 transition duration-200" title="Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ù…ÙØªØ§Ø­ API">
                <!-- Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…ÙØªØ§Ø­ -->
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25a3 3 0 013 3v2.25m-3-4.5v1.248a4.5 4.5 0 00-.083.541m-3.75-5.25v2.25m3.75-2.25h-3.75m-3.75 0h3.75m-3.75 0a3 3 0 00-3 3v2.25m3-4.5v1.248a4.5 4.5 0 01-.083.541m0 0a4.504 4.504 0 00-3.75 3.75v1.875a3.375 3.375 0 003.375 3.375h1.25M12 21.75l-4.75-4.75M12 21.75L16.75 17m-4.75 4.75V17" />
                </svg>
            </button>
        </div>
        
        <!-- Ù…Ù†Ø·Ù‚Ø© Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙØªØ§Ø­ API (Ù…Ø®ÙÙŠØ© Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹) -->
        <div id="api-input-container" class="api-input-container px-4">
            <p class="text-sm opacity-80 mb-2">Ø¥Ø°Ø§ ÙƒÙ†Øª ØªØ³ØªØ®Ø¯Ù… Ù†Ù…ÙˆØ°Ø¬Ø§Ù‹ Ø®Ø§Ø±Ø¬ Ø¨ÙŠØ¦Ø© CanvasØŒ Ø£Ø¯Ø®Ù„ Ù…ÙØªØ§Ø­ API Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ:</p>
            <div class="flex space-x-2 rtl:space-x-reverse">
                <input type="password" id="api-key-input" placeholder="Ø£Ø¯Ø®Ù„ Ù…ÙØªØ§Ø­ Google AI API Key Ù‡Ù†Ø§" 
                       class="w-full p-2 rounded-lg text-gray-900 border border-gray-300 focus:ring-indigo-400 focus:border-indigo-400">
                <button id="save-api-key-button" 
                        class="button-effect flex-shrink-0 bg-gray-200 text-gray-700 hover:bg-gray-300 p-2 rounded-lg text-sm transition duration-200 opacity-80"
                        title="Ø­ÙØ¸ Ø§Ù„Ù…ÙØªØ§Ø­ Ù…Ø­Ù„ÙŠØ§Ù‹">
                    Ø­ÙØ¸
                </button>
            </div>
            <p class="text-xs mt-1 opacity-70">Ù…Ù„Ø§Ø­Ø¸Ø©: ÙÙŠ Ø¨ÙŠØ¦Ø© Ø§Ù„Ø¹Ø±Ø¶ (Canvas)ØŒ Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙØªØ§Ø­ Ù…ÙØ¯Ù…Ø¬ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.</p>
        </div>
        
        <p class="text-sm text-center opacity-80 pb-4 pt-2">Ø¯Ø±Ø¯Ø´Ø©ØŒ ØªÙ„Ø®ÙŠØµØŒ ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„Ù†Ø·Ù‚ Ø§Ù„ØµÙˆØªÙŠ</p>
    </header>

    <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
    <main class="flex-grow p-4 overflow-y-auto" id="chat-window">
        <!-- Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ Ø§Ù„Ø£ÙˆÙ„ÙŠØ© -->
        <div class="flex justify-start mb-4 ai-message-row">
            <div class="max-w-3/4 bg-gray-100 p-3 rounded-xl shadow-md text-gray-800 rtl:text-right">
                <p class="font-medium text-indigo-600 mb-1">Rsbalo-Ø±Ø³Ø¨Ø§Ù„Ùˆ</p>
                <div class="message-content">
                    <p class="leading-relaxed message-content-text">
                        Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ! Ø£Ù†Ø§ "Ø±Ø³Ø¨Ø§Ù„Ùˆ"ØŒ Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø°ÙƒÙŠ ÙÙŠ Ø§Ù„Ø¯Ø±Ø§Ø³Ø©.
                        Ù„Ù‚Ø¯ ØªÙ… ØªØ¯Ø±ÙŠØ¨ÙŠ Ø®ØµÙŠØµØ§Ù‹ Ø¹Ù„Ù‰ **Ø¥ØªÙ‚Ø§Ù† Ø£ÙŠ Ù„Ù‡Ø¬Ø© ØªØ·Ù„Ø¨Ù‡Ø§ (Ù…ØµØ±ÙŠØŒ Ø³Ø¹ÙˆØ¯ÙŠØŒ Ø´Ø§Ù…ÙŠØŒ Ø¥Ù„Ø®) Ø¨Ø¯Ù‚Ø© 100%** ÙˆØ¹Ù„Ù‰ **Ø´Ø±Ø­ Ø§Ù„Ø¯Ø±ÙˆØ³ Ø¨Ø°ÙƒØ§Ø¡ ÙˆØ´Ù…ÙˆÙ„ÙŠØ© Ø¹Ø§Ù„ÙŠØ© Ø¬Ø¯Ø§Ù‹** ÙˆÙ„ÙƒÙ† Ø¨Ø£Ø³Ù„ÙˆØ¨ **Ù…Ø¨Ø³Ø· ÙˆØ³Ù‡Ù„** ÙŠÙ…Ù†Ø¹ Ø£ÙŠ ØªØ¹Ù‚ÙŠØ¯.
                        ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø§Ù„ÙŠÙˆÙ…ØŸ
                    </p>
                </div>
                <!-- Ù…ÙƒØ§Ù† Ø²Ø± Ø§Ù„Ù†Ø·Ù‚ Ø§Ù„ØµÙˆØªÙŠ (Ø³ÙŠÙØ¶Ø§Ù Ø¨ÙˆØ§Ø³Ø·Ø© JavaScript) -->
            </div>
        </div>

        <!-- Ù…Ø¤Ø´Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø© (ÙŠØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø¯) -->
        <div class="flex justify-start mb-4 hidden" id="typing-indicator">
            <div class="bg-gray-200 p-3 rounded-xl shadow-sm">
                <p class="font-medium text-indigo-600 mb-1">Rsbalo-Ø±Ø³Ø¨Ø§Ù„Ùˆ ÙŠÙƒØªØ¨</p>
                <div class="flex items-center">
                    <span class="typing-dot"></span>
                    <span class="typing-dot"></span>
                    <span class="typing-dot"></span>
                </div>
            </div>
        </div>

        <!-- Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ØªØ¶Ø§Ù Ù‡Ù†Ø§ -->
    </main>
    
    <!-- Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ø§Ù… (ÙŠØ¸Ù‡Ø± ÙÙˆÙ‚ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ API) -->
    <div id="loading-indicator" class="hidden fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50">
        <div class="bg-white p-4 rounded-xl shadow-2xl flex items-center space-x-3 rtl:space-x-reverse">
            <svg class="animate-spin h-6 w-6 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span id="loading-text" class="text-gray-700 font-medium">Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</span>
        </div>
    </div>


    <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ÙˆØ§Ù„ØªØ­ÙƒÙ… -->
    <div class="bg-white p-4 border-t border-gray-300 shadow-2xl">
        <div class="flex items-end max-w-4xl mx-auto space-x-3 rtl:space-x-reverse">
            
            <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© -->
            <div class="relative flex-shrink-0" id="tools-dropdown-container">
                <button id="tools-toggle-button" class="button-effect bg-gray-200 text-gray-700 hover:bg-gray-300 p-3 rounded-xl flex items-center justify-center transition duration-200 disabled:opacity-50" title="Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¯Ø±Ø§Ø³Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©">
                    <!-- Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù…ÙØªØ§Ø­ -->
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M11.42 15.17L17.25 21A2.25 2.25 0 0019.5 18.75V10.5m-18 6L11.42 15.17m0 0L21 4.5 14.83 10.33m-10.4 4.84L21 4.5M12.75 18.75h3M12.75 12h3" />
                    </svg>
                </button>
                <div id="tools-menu" class="absolute bottom-full mb-2 right-0 w-48 bg-white rounded-xl shadow-xl border border-gray-200 py-1 hidden z-10">
                    <button id="summarize-option" class="w-full text-right px-4 py-2 text-sm text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 transition duration-150 rounded-lg flex items-center justify-end">
                        <span class="font-medium">ØªÙ„Ø®ÙŠØµ Ù†Øµ</span>
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m6.75 12l-3-3m0 0l-3 3m3-3v-4.5m4.75 8.25a.75.75 0 100-1.5.75.75 0 000 1.5z" />
                        </svg>
                    </button>
                    <button id="quiz-option" class="w-full text-right px-4 py-2 text-sm text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 transition duration-150 rounded-lg flex items-center justify-end">
                        <span class="font-medium">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø±</span>
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M10.125 3.75h9.75M10.125 3.75c3.5 0 6.375 2.875 6.375 6.375m-6.375-6.375v2.875a6.375 6.375 0 00-6.375 6.375v1.25M10.125 3.75v12.375m3.75-9.75h-1.25m-3.75-3.75h-1.25m-3.75 0h-1.25M12.375 18v1.25m0 0a2.25 2.25 0 11-4.5 0M12.375 19.25h1.25" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ -->
            <textarea id="user-input" class="flex-grow p-3 border border-gray-300 rounded-xl resize-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200 text-gray-800"
                      rows="1" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„ÙƒØŒ Ø£Ùˆ Ø§Ù„ØµÙ‚ Ù†ØµØ§Ù‹ Ù„ÙƒÙŠ ØªÙ„Ø®ØµÙ‡ Ø£Ùˆ ØªØ­ÙˆÙ„Ù‡ Ù„Ø§Ø®ØªØ¨Ø§Ø±..." style="max-height: 150px;"></textarea>
            
            <!-- Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ -->
            <button id="send-button" class="button-effect flex-shrink-0 bg-indigo-600 text-white p-3 rounded-xl hover:bg-indigo-700 transition duration-200 disabled:opacity-50" title="Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©">
                <!-- Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ (Ø§Ù„Ø³Ù‡Ù…) -->
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 -rotate-90 rtl:rotate-90">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" />
                </svg>
            </button>
        </div>
    </div>
    
    <!-- Ø§Ù„ØªØ°ÙŠÙŠÙ„ (Footer) -->
    <footer class="bg-gray-100 p-2 text-center text-gray-500 text-sm border-t border-gray-200">
        <p>Ù…Ù† ØµÙ†Ø¹ <span class="font-bold text-indigo-600">Ù‡Ø±ÙŠØ§Ø³ÙˆØ±</span></p>
    </footer>

    <script>
        // ------------------------------------------------
        // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ© ÙˆØ§Ù„Ø«ÙˆØ§Ø¨Øª
        // ------------------------------------------------
        const USER_API_KEY_STORAGE_KEY = 'rsbalo_user_api_key'; // Ù…ÙØªØ§Ø­ Ø§Ù„Ø­ÙØ¸ ÙÙŠ localStorage

        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const chatWindow = document.getElementById('chat-window');
        const typingIndicator = document.getElementById('typing-indicator');
        const loadingIndicator = document.getElementById('loading-indicator');
        const loadingText = document.getElementById('loading-text');

        const toolsToggleButton = document.getElementById('tools-toggle-button');
        const toolsMenu = document.getElementById('tools-menu');
        const summarizeOption = document.getElementById('summarize-option');
        const quizOption = document.getElementById('quiz-option');

        // Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù…ÙØªØ§Ø­ API
        const apiKeyToggle = document.getElementById('api-key-toggle');
        const apiKeyInputContainer = document.getElementById('api-input-container');
        const apiKeyInput = document.getElementById('api-key-input');
        const saveApiKeyButton = document.getElementById('save-api-key-button');


        let chatHistory = [];
        let isLoading = false;
        let audio = null; // Ù„ØªØ®Ø²ÙŠÙ† ÙƒØ§Ø¦Ù† Ø§Ù„ØµÙˆØª Ø§Ù„Ø­Ø§Ù„ÙŠ (TTS)

        // Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù€ API Ù„Ù€ Gemini Chat
        const chatApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=`;
        // Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù€ API Ù„Ù€ Gemini TTS
        const ttsApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=`;

        /**
         * Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙØªØ§Ø­ Ø§Ù„Ù€ API Ø§Ù„Ø­Ø§Ù„ÙŠØŒ Ø¥Ù…Ø§ Ù…Ù† Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ØŒ Ø£Ùˆ Ø§Ù„Ù…Ø­ÙÙˆØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹ØŒ Ø£Ùˆ ÙØ§Ø±ØºØ§Ù‹.
         * @returns {string} Ù…ÙØªØ§Ø­ Ø§Ù„Ù€ API.
         */
        function getCurrentApiKey() {
            // Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ù„Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø© ÙÙŠ Ø§Ù„Ø­Ù‚Ù„ (Ù„Ù„ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©)
            const inputKey = apiKeyInput.value.trim();
            if (inputKey) return inputKey;
            
            // Ø§Ù„Ø«Ù†Ø§Ø¦ÙŠØ© Ù„Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ù…Ø­ÙÙˆØ¸
            const storedKey = localStorage.getItem(USER_API_KEY_STORAGE_KEY);
            if (storedKey) return storedKey;

            // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙŠ Ø´ÙŠØ¡ØŒ Ø¥Ø±Ø¬Ø§Ø¹ Ø³Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ© (Ø³ØªØ³ØªØ®Ø¯Ù… Ø¨ÙŠØ¦Ø© Canvas Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ù…Ø¯Ù…Ø¬)
            return "";
        }

        // ------------------------------------------------
        // ÙˆØ¸Ø§Ø¦Ù ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (UI)
        // ------------------------------------------------

        /**
         * ØªØ¨Ø¯ÙŠÙ„ Ø¹Ø±Ø¶ Ù…Ù†Ø·Ù‚Ø© Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙØªØ§Ø­ API.
         */
        function toggleApiKeyInput() {
            apiKeyInputContainer.classList.toggle('open');
        }
        
        /**
         * Ø­ÙØ¸ Ù…ÙØªØ§Ø­ API ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ.
         */
        function saveApiKey() {
            const key = apiKeyInput.value.trim();
            if (key) {
                localStorage.setItem(USER_API_KEY_STORAGE_KEY, key);
                
                // Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ù‚ØµÙŠØ±Ø©
                const originalText = saveApiKeyButton.textContent;
                saveApiKeyButton.textContent = 'âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸!';
                saveApiKeyButton.classList.add('save-btn-success');

                setTimeout(() => {
                    saveApiKeyButton.textContent = originalText;
                    saveApiKeyButton.classList.remove('save-btn-success');
                }, 2000);

            } else {
                // Ø±Ø³Ø§Ù„Ø© ØªÙ†Ø¨ÙŠÙ‡ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø­Ù‚Ù„ ÙØ§Ø±ØºØ§Ù‹
                 const originalText = saveApiKeyButton.textContent;
                saveApiKeyButton.textContent = 'âš ï¸ Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…ÙØªØ§Ø­ Ø£ÙˆÙ„Ø§Ù‹';
                saveApiKeyButton.classList.add('bg-red-500', 'hover:bg-red-600', 'text-white');
                saveApiKeyButton.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');


                setTimeout(() => {
                    saveApiKeyButton.textContent = originalText;
                    saveApiKeyButton.classList.remove('bg-red-500', 'hover:bg-red-600', 'text-white');
                    saveApiKeyButton.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                }, 2000);
            }
        }

        /**
         * ØªØ­Ù…ÙŠÙ„ Ù…ÙØªØ§Ø­ API Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„.
         */
        function loadApiKey() {
            const storedKey = localStorage.getItem(USER_API_KEY_STORAGE_KEY);
            if (storedKey) {
                apiKeyInput.value = storedKey;
            }
        }
        
        /**
         * Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø©.
         */
        function showTypingIndicator() {
            chatWindow.appendChild(typingIndicator);
            typingIndicator.classList.remove('hidden');
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        /**
         * Ø¥Ø®ÙØ§Ø¡ Ù…Ø¤Ø´Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø©.
         */
        function hideTypingIndicator() {
            typingIndicator.classList.add('hidden');
        }

        /**
         * Ø¨Ù†Ø§Ø¡ ÙˆØªØ¬Ù‡ÙŠØ² Ø²Ø± Ø§Ù„Ù†Ø·Ù‚ Ø§Ù„ØµÙˆØªÙŠ.
         * @param {string} text - Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø±Ø§Ø¯ Ù†Ø·Ù‚Ù‡.
         * @returns {HTMLElement} Ø²Ø± Ø§Ù„ØªØ´ØºÙŠÙ„ Ù…Ø¹ Ø±Ø¨Ø· Ø­Ø¯Ø« Ø§Ù„Ù†Ù‚Ø±.
         */
        function createTTSButton(text) {
            const ttsButtonContainer = document.createElement('div');
            ttsButtonContainer.className = 'mt-3 pt-3 border-t border-gray-300';
            
            const ttsButton = document.createElement('button');
            ttsButton.id = 'tts-play-button';
            ttsButton.className = 'bg-indigo-500 hover:bg-indigo-600 text-white text-sm py-1 px-3 rounded-lg transition duration-200 shadow-md flex items-center rtl:flex-row-reverse disabled:opacity-50';
            ttsButton.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 ml-2 rtl:mr-2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.114 5.636A9 9 0 0112 2.25C6.901 2.25 2.65 6.004 2.222 11.02a.75.75 0 00.776.985A14.914 14.914 0 0012 14.25c2.404 0 4.707-.66 6.745-1.898a.75.75 0 00.569-.643c.125-.972.338-1.928.6-2.862.333-1.168.514-2.333.514-3.513zm-9.011 3.228a.75.75 0 00-1.06 1.06L10.94 13.5l-2.887 2.887a.75.75 0 101.06 1.06L12 14.56l2.887 2.887a.75.75 0 101.06-1.06L13.06 13.5l2.887-2.887a.75.75 0 10-1.06-1.06L12 12.44l-2.887-2.887z" />
                </svg>
                <span class="font-medium">Ø§Ù„Ù†Ø·Ù‚ Ø§Ù„ØµÙˆØªÙŠ</span>
            `;
            
            ttsButton.addEventListener('click', () => {
                const allTtsButtons = document.querySelectorAll('#tts-play-button');
                // ØªØ¹Ø·ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù„Ù…Ù†Ø¹ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯
                allTtsButtons.forEach(btn => btn.disabled = true);
                readMessageAloud(text, ttsButton);
            });
            
            ttsButtonContainer.appendChild(ttsButton);
            return ttsButtonContainer;
        }

        /**
         * Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….
         * @param {string} role - Ø¯ÙˆØ± Ø§Ù„Ø±Ø³Ø§Ù„Ø© ('user' Ø£Ùˆ 'model').
         * @param {string} text - Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø©.
         * @param {string} type - Ù†ÙˆØ¹ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ('chat', 'summary_request', 'summary_response', 'quiz_request', 'quiz_response').
         */
        function addMessageToUI(role, text, type) {
            // Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ø´Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙÙŠ ÙƒÙ„ Ù…Ø±Ø© ØªÙØ¶Ø§Ù ÙÙŠÙ‡Ø§ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©
            if (typingIndicator.parentNode === chatWindow) {
                hideTypingIndicator();
            }

            const messageRow = document.createElement('div');
            messageRow.className = `flex mb-4 ${role === 'user' ? 'justify-end user-message-row' : 'justify-start ai-message-row'}`;

            const isUser = role === 'user';
            
            let backgroundColor, titleText, titleColor;
            
            switch(type) {
                case 'summary_request':
                    backgroundColor = isUser ? 'bg-indigo-100' : 'bg-green-100';
                    titleText = isUser ? 'Ø·Ù„Ø¨ ØªÙ„Ø®ÙŠØµ Ø§Ù„Ù†Øµ' : 'ØªÙ„Ø®ÙŠØµ Ø§Ù„Ù†Øµ';
                    titleColor = isUser ? 'text-indigo-600' : 'text-green-600';
                    break;
                case 'quiz_request':
                    backgroundColor = isUser ? 'bg-indigo-100' : 'bg-teal-100';
                    titleText = isUser ? 'Ø§Ù„Ù†Øµ Ø§Ù„Ù…ÙØ¯Ø®Ù„ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±' : 'Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø§Ù‡Ø²Ø©';
                    titleColor = isUser ? 'text-indigo-600' : 'text-teal-600';
                    break;
                case 'summary_response':
                    backgroundColor = 'bg-green-100';
                    titleText = 'Ø§Ù„Ù…Ù„Ø®Øµ';
                    titleColor = 'text-green-600';
                    break;
                case 'quiz_response':
                    backgroundColor = 'bg-teal-100';
                    titleText = 'Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±';
                    titleColor = 'text-teal-600';
                    break;
                case 'chat':
                default:
                    backgroundColor = isUser ? 'bg-indigo-500 text-white' : 'bg-white text-gray-800 border border-gray-200 shadow-lg';
                    titleText = isUser ? 'Ø£Ù†Ø§' : 'Rsbalo-Ø±Ø³Ø¨Ø§Ù„Ùˆ';
                    titleColor = isUser ? 'text-white' : 'text-indigo-600';
            }


            const messageContent = document.createElement('div');
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… max-w-full Ù„Ù„Ù‡Ø§ØªÙ Ùˆ max-w-3xl Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„Ø£ÙƒØ¨Ø±
            messageContent.className = `max-w-full md:max-w-3xl p-3 rounded-xl shadow-lg ${backgroundColor} ${isUser ? 'text-white' : 'text-gray-800'} rtl:text-right`;

            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù†ÙˆØ§Ù†/Ø§Ù„Ø¯ÙˆØ±
            const title = document.createElement('p');
            title.className = `font-bold mb-1 ${titleColor}`;
            title.textContent = titleText;
            messageContent.appendChild(title);

            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Øµ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
            const textParagraph = document.createElement('p');
            textParagraph.className = 'leading-relaxed whitespace-pre-wrap message-content-text';
            textParagraph.innerHTML = text; // Ø§Ø³ØªØ®Ø¯Ø§Ù… innerHTML Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨ØªÙ†Ø³ÙŠÙ‚ Markdown Ø§Ù„Ù…Ø­ÙˆÙ„
            messageContent.appendChild(textParagraph);

            // Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø§Ù„Ù†Ø·Ù‚ Ø§Ù„ØµÙˆØªÙŠ Ù„Ù„Ø±Ø¯ÙˆØ¯ ØºÙŠØ± Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            if (role === 'model' && type !== 'summary_request' && type !== 'quiz_request') {
                const ttsButtonHtml = createTTSButton(text);
                messageContent.appendChild(ttsButtonHtml);
            }
            
            messageRow.appendChild(messageContent);
            chatWindow.appendChild(messageRow);
            // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ø£Ø³ÙÙ„ Ø§Ù„Ù†Ø§ÙØ°Ø©
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        /**
         * ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ (Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆÙ…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„).
         * @param {boolean} loading - Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„.
         * @param {string} currentAction - Ø§Ù„Ù†Øµ Ø§Ù„Ø°ÙŠ Ø³ÙŠØ¸Ù‡Ø± ÙÙŠ Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„.
         */
        function setLoading(loading, currentAction = 'Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...') {
            isLoading = loading;
            
            // ØªØ¹Ø·ÙŠÙ„ ÙƒØ§ÙØ© Ø­Ù‚ÙˆÙ„ ÙˆØ£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
            userInput.disabled = loading;
            sendButton.disabled = loading;
            toolsToggleButton.disabled = loading; 
            apiKeyToggle.disabled = loading;
            saveApiKeyButton.disabled = loading;
            
            // ØªØ¹Ø·ÙŠÙ„/ØªÙØ¹ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø£Ø²Ø±Ø§Ø± TTS Ø¨Ø´ÙƒÙ„ Ø¬Ù…Ø§Ø¹ÙŠ
            document.querySelectorAll('#tts-play-button').forEach(btn => {
                 // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù‡Ùˆ "false"ØŒ ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ ØµÙˆØª Ù‚ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„
                btn.disabled = loading; 
            });


            loadingIndicator.classList.toggle('hidden', !loading);
            loadingText.textContent = currentAction;
        }
        
        /**
         * ØªØ­Ø¯ÙŠØ« Ø­Ø¬Ù… Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ù„ÙŠØªÙ†Ø§Ø³Ø¨ Ù…Ø¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ (Ù„ØªØ­Ø³ÙŠÙ† ØªØ¬Ø±Ø¨Ø© Ù„ØµÙ‚ Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ø·ÙˆÙŠÙ„Ø©).
         */
        function resizeInput() {
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† rows Ø¥Ù„Ù‰ 1 Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø·ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
            userInput.style.height = 'auto';
            userInput.rows = 1; 

            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ÙˆØªØ·Ø¨ÙŠÙ‚Ù‡
            let scrollHeight = userInput.scrollHeight;
            let maxHeight = 150; // Ø­Ø¯ Ø£Ù‚ØµÙ‰ Ù„Ù„Ø§Ø±ØªÙØ§Ø¹ Ø¨Ø§Ù„Ø¨ÙƒØ³Ù„

            if (scrollHeight > maxHeight) {
                userInput.style.height = maxHeight + 'px';
            } else {
                userInput.style.height = scrollHeight + 'px';
            }
        }
        
        // Ø±Ø¨Ø· Ø¯Ø§Ù„Ø© ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø¬Ù… Ø¨Ø­Ø¯Ø« Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
        userInput.addEventListener('input', resizeInput);
        
        // ------------------------------------------------
        // ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ API Ù…Ø¹ Ø¢Ù„ÙŠØ© Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø§Ù„Ø£Ø³ÙŠ (Exponential Backoff)
        // ------------------------------------------------

        async function exponentialBackoffFetch(url, options, maxRetries = 5) {
            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙØªØ§Ø­ API Ù…Ù† Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
            const apiKey = getCurrentApiKey(); 
            const fullUrl = `${url}${apiKey}`;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(fullUrl, options);
                    if (response.ok) {
                        return response;
                    }
                    // Handle rate limiting (429) and server errors (5xx)
                    if (response.status === 429 || response.status >= 500) {
                        // Ù„Ù† Ù†Ø³Ø¬Ù„ Ù‡Ø°Ø§ ÙƒØ®Ø·Ø£ ÙÙŠ ÙˆØ­Ø¯Ø© Ø§Ù„ØªØ­ÙƒÙ…
                        throw new Error(`Server or rate limit error: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    // Ù„Ù† Ù†Ø³Ø¬Ù„ Ù‡Ø°Ø§ ÙƒØ®Ø·Ø£ ÙÙŠ ÙˆØ­Ø¯Ø© Ø§Ù„ØªØ­ÙƒÙ…
                    if (i === maxRetries - 1) {
                        throw new Error('API request failed after multiple retries.');
                    }
                    const delay = Math.pow(2, i) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }
        
        // ------------------------------------------------
        // ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù€ TTS (ØªØ­ÙˆÙŠÙ„ PCM Ø¥Ù„Ù‰ WAV)
        // ------------------------------------------------

        /**
         * ØªØ­ÙˆÙŠÙ„ Base64 Ø¥Ù„Ù‰ ArrayBuffer.
         */
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        /**
         * ØªØ­ÙˆÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª PCM 16-bit Ø¥Ù„Ù‰ Blob Ø¨ØªÙ†Ø³ÙŠÙ‚ WAV.
         * @param {Int16Array} pcm16 - Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙˆØª Ø¨ØµÙŠØºØ© PCM 16-bit.
         * @param {number} sampleRate - Ù…Ø¹Ø¯Ù„ Ø£Ø®Ø° Ø§Ù„Ø¹ÙŠÙ†Ø§Øª.
         * @returns {Blob} Ù…Ù„Ù WAV ÙƒÙ€ Blob.
         */
        function pcmToWav(pcm16, sampleRate) {
            const numChannels = 1;
            const bytesPerSample = 2; // 16-bit PCM

            const buffer = new ArrayBuffer(44 + pcm16.length * bytesPerSample);
            const view = new DataView(buffer);

            // ÙˆØ¸ÙŠÙØ© Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø³Ù„Ø§Ø³Ù„ (Strings)
            function writeString(view, offset, string) {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            }

            // RIFF chunk descriptor
            writeString(view, 0, 'RIFF'); // ChunkID
            view.setUint32(4, 36 + pcm16.length * bytesPerSample, true); // ChunkSize
            writeString(view, 8, 'WAVE'); // Format

            // FMT sub-chunk
            writeString(view, 12, 'fmt '); // Subchunk1ID
            view.setUint32(16, 16, true); // Subchunk1Size (16 for PCM)
            view.setUint16(20, 1, true); // AudioFormat (1 for PCM)
            view.setUint16(22, numChannels, true); // NumChannels
            view.setUint32(24, sampleRate, true); // SampleRate
            view.setUint32(28, sampleRate * numChannels * bytesPerSample, true); // ByteRate
            view.setUint16(32, numChannels * bytesPerSample, true); // BlockAlign
            view.setUint16(34, bytesPerSample * 8, true); // BitsPerSample

            // DATA sub-chunk
            writeString(view, 36, 'data'); // Subchunk2ID
            view.setUint32(40, pcm16.length * bytesPerSample, true); // Subchunk2Size

            // Write PCM data
            for (let i = 0; i < pcm16.length; i++) {
                view.setInt16(44 + i * bytesPerSample, pcm16[i], true);
            }

            return new Blob([view], { type: 'audio/wav' });
        }


        /**
         * ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Øµ Ø§Ù„ØµÙˆØªÙŠ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… TTS API.
         * @param {string} text - Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø±Ø§Ø¯ Ù†Ø·Ù‚Ù‡.
         * @param {HTMLElement} playButton - Ø²Ø± Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø­Ø¯Ø¯.
         */
        async function readMessageAloud(text, playButton) {
             // Ø¥ÙŠÙ‚Ø§Ù Ø£ÙŠ ØªØ´ØºÙŠÙ„ Ø³Ø§Ø¨Ù‚ ÙˆØªØ¯Ù…ÙŠØ±Ù‡
            if (audio) {
                audio.pause();
                audio = null;
                // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³Ø§Ø¨Ù‚ (ÙÙŠ Ø­Ø§Ù„ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø²Ø± Ø¢Ø®Ø± ÙŠØ¹Ù…Ù„)
                document.querySelectorAll('#tts-play-button').forEach(btn => btn.disabled = false);
            }

            // ØªÙØ¹ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ø§Ù…Ø©
            setLoading(true, 'Rsbalo-Ø±Ø³Ø¨Ø§Ù„Ùˆ ÙŠØ­ÙˆÙ„ Ø§Ù„Ù†Øµ Ø¥Ù„Ù‰ ØµÙˆØª...');
            playButton.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...'; // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø²Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯

            const ttsPayload = {
                contents: [{
                    parts: [{ text: `Ù‚Ù„ Ø¨Ù‡Ø¯ÙˆØ¡ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©: ${text}` }] // Ø¥Ø¶Ø§ÙØ© ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù†Ø·Ù‚
                }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: "Algieba" } // Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØª Ø¹Ø±Ø¨ÙŠ Ù…Ù†Ø§Ø³Ø¨
                        }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };

            const ttsOptions = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(ttsPayload)
            };

            let audioUrl;

            try {
                const response = await exponentialBackoffFetch(ttsApiUrl, ttsOptions);
                const result = await response.json();

                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø¹Ø¯Ù„ Ø£Ø®Ø° Ø§Ù„Ø¹ÙŠÙ†Ø§Øª Ù…Ù† Ø§Ù„Ù€ MimeType: audio/L16;rate=24000
                    const rateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = rateMatch ? parseInt(rateMatch[1], 10) : 24000;
                    
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    audioUrl = URL.createObjectURL(wavBlob);
                    
                    audio = new Audio(audioUrl);
                    audio.play();

                    playButton.innerHTML = 'ğŸ”Š Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù†Ø·Ù‚...';
                    setLoading(false); // Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ø§Ù… Ø¨Ù…Ø¬Ø±Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„

                    // Ø¹Ù†Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
                    audio.onended = () => {
                        playButton.innerHTML = '<span class="font-medium">Ø§Ù„Ù†Ø·Ù‚ Ø§Ù„ØµÙˆØªÙŠ</span>';
                        // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø£Ø²Ø±Ø§Ø± TTS ÙˆØ§Ù„ØªØ­ÙƒÙ…
                        document.querySelectorAll('#tts-play-button').forEach(btn => btn.disabled = false);
                        setLoading(false);
                        URL.revokeObjectURL(audioUrl); // ØªØ­Ø±ÙŠØ± Ø§Ù„Ø°Ø§ÙƒØ±Ø©
                    };

                    // Ø¹Ù†Ø¯ Ø­Ø¯ÙˆØ« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ´ØºÙŠÙ„
                    audio.onerror = (e) => {
                        console.error("Audio playback error:", e);
                        playButton.innerHTML = 'âŒ Ø®Ø·Ø£ ØªØ´ØºÙŠÙ„';
                        // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø£Ø²Ø±Ø§Ø± TTS ÙˆØ§Ù„ØªØ­ÙƒÙ…
                        document.querySelectorAll('#tts-play-button').forEach(btn => btn.disabled = false);
                        setLoading(false);
                        if (audioUrl) URL.revokeObjectURL(audioUrl); 
                    };


                } else {
                    addMessageToUI('model', 'Ø¹Ø°Ø±Ø§Ù‹ØŒ ÙØ´Ù„Øª Ø¹Ù…Ù„ÙŠØ© ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØµÙˆØª. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', 'chat');
                }

            } catch (error) {
                console.error('Gemini TTS API Error:', error);
                addMessageToUI('model', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ© Ø£Ùˆ Ø§Ù„Ù€ API Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ù†Ø·Ù‚ Ø§Ù„ØµÙˆØªÙŠ.', 'chat');
            } finally {
                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ø§Ù… ÙÙŠ Ø­Ø§Ù„ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø£Ùˆ Ø®Ø·Ø£ Ø¢Ø®Ø±
                if (!audio || audio.ended || audio.error) {
                    setLoading(false);
                    // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø²Ø± Ø¥Ù„Ù‰ Ø­Ø§Ù„ØªÙ‡ Ø§Ù„Ø£ØµÙ„ÙŠØ©
                    playButton.innerHTML = '<span class="font-medium">Ø§Ù„Ù†Ø·Ù‚ Ø§Ù„ØµÙˆØªÙŠ</span>';
                    // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
                    document.querySelectorAll('#tts-play-button').forEach(btn => btn.disabled = false);
                }
            }
        }


        // ------------------------------------------------
        // ÙˆØ¸ÙŠÙØ© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ (ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©)
        // ------------------------------------------------

        async function sendMessage() {
            const userText = userInput.value.trim();
            if (!userText || isLoading) return;

            // 1. Ù…Ø³Ø­ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            userInput.value = '';
            resizeInput(); 
            addMessageToUI('user', userText, 'chat');
            
            // 2. ØªÙØ¹ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø©
            setLoading(true, 'Rsbalo-Ø±Ø³Ø¨Ø§Ù„Ùˆ ÙŠØ¨Ø­Ø«...');
            showTypingIndicator();

            // Ø¥ÙŠÙ‚Ø§Ù Ø£ÙŠ ØªØ´ØºÙŠÙ„ ØµÙˆØªÙŠ Ø³Ø§Ø¨Ù‚
            if (audio) {
                audio.pause();
                audio = null;
                // ØªÙØ¹ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø£Ø²Ø±Ø§Ø± TTS Ø§Ù„Ø£Ø®Ø±Ù‰
                document.querySelectorAll('#tts-play-button').forEach(btn => btn.disabled = false);
            }


            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
            const userMessage = { role: "user", parts: [{ text: userText }] };
            chatHistory.push(userMessage);

            // ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù‡Ù†Ø§ Ù„ØªØ´Ù…Ù„ Ø¥ØªÙ‚Ø§Ù† Ø§Ù„Ù„Ù‡Ø¬Ø§Øª ÙˆØ§Ù„Ø´Ø±Ø­ Ø§Ù„Ø°ÙƒÙŠ ÙˆØ§Ù„Ø´Ø§Ù…Ù„ ÙˆØ§Ù„Ù…Ø¨Ø³Ø·
            const systemPrompt = "Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ø¯Ø±Ø§Ø³Ø© ÙˆÙ…Ø¹Ù„Ù… Ø®Ø§Øµ ÙØ§Ø¦Ù‚ Ø§Ù„Ø°ÙƒØ§Ø¡. Ù…Ù‡Ù…ØªÙƒ Ù‡ÙŠ: 1. **Ø¥ØªÙ‚Ø§Ù† Ø£ÙŠ Ù„Ù‡Ø¬Ø© Ø¹Ø±Ø¨ÙŠØ© ØªÙØ·Ù„Ø¨ Ù…Ù†Ùƒ (Ù…Ø«Ù„ Ø§Ù„Ù…ØµØ±ÙŠØ©ØŒ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©ØŒ Ø§Ù„Ø´Ø§Ù…ÙŠØ©ØŒ Ø¥Ù„Ø®) ÙˆØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ø±Ø¯ Ø¨Ù‡Ø§ Ø¨Ø¯Ù‚Ø© 100%**. 2. **Ø´Ø±Ø­ Ø§Ù„Ø¯Ø±ÙˆØ³ Ø¨Ø°ÙƒØ§Ø¡ ÙØ§Ø¦Ù‚ ÙˆØ´Ù…ÙˆÙ„ÙŠØ© Ø¹Ø§Ù„ÙŠØ©:** ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ Ø¬Ù…Ø¹ ÙˆØªÙ‚Ø¯ÙŠÙ… **ÙƒÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¯Ø±Ø³** Ø¨Ø£Ø³Ù„ÙˆØ¨ **Ù…Ø¨Ø³Ø· ÙˆØ³Ù‡Ù„ Ø¬Ø¯Ø§Ù‹ØŒ ÙˆØ¨Ø¹ÙŠØ¯ ØªÙ…Ø§Ù…Ø§Ù‹ Ø¹Ù† Ø§Ù„ØªØ¹Ù‚ÙŠØ¯**. Ø§Ø³ØªØ®Ø¯Ù… Ø£Ø³Ù„ÙˆØ¨Ø§Ù‹ ÙˆØ¯ÙŠØ§Ù‹ ÙˆØ¯Ø§Ø¹Ù…Ø§Ù‹ØŒ ÙˆØªØ£ÙƒØ¯ Ù…Ù† Ø¯Ù‚Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙˆØ­Ø¯Ø§Ø«ØªÙ‡Ø§.";

            const payload = {
                contents: chatHistory,
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                tools: [{ "google_search": {} }], 
            };

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            try {
                const response = await exponentialBackoffFetch(chatApiUrl, options);
                const result = await response.json();

                if (result.candidates && result.candidates.length > 0) {
                    const candidate = result.candidates[0];
                    const aiResponseText = candidate.content?.parts?.[0]?.text;

                    if (aiResponseText) {
                        addMessageToUI('model', aiResponseText, 'chat');
                        const aiMessage = { role: "model", parts: [{ text: aiResponseText }] };
                        chatHistory.push(aiMessage);
                    } else {
                        addMessageToUI('model', 'Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ù… Ø£ØªÙ…ÙƒÙ† Ù…Ù† ØªÙˆÙ„ÙŠØ¯ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù†ØµÙŠØ©.', 'chat');
                        chatHistory.pop(); 
                    }
                } else {
                    const errorMessage = result.error?.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ (Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©).';
                    addMessageToUI('model', `Ø­Ø¯Ø« Ø®Ø·Ø£: ${errorMessage}`, 'chat');
                    chatHistory.pop(); 
                }

            } catch (error) {
                console.error('Gemini Chat API Error:', error);
                addMessageToUI('model', `Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ© Ø£Ùˆ Ø§Ù„Ù€ API Ù„Ù„Ø¯Ø±Ø¯Ø´Ø©. (Ø§Ù„ØªÙØ§ØµÙŠÙ„: ${error.message})`, 'chat');
                chatHistory.pop(); 
            } finally {
                // 3. Ø¥Ø®ÙØ§Ø¡ Ù…Ø¤Ø´Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙˆØ­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
                hideTypingIndicator();
                setLoading(false);
            }
        }

        // ------------------------------------------------
        // ÙˆØ¸ÙŠÙØ© ØªÙ„Ø®ÙŠØµ Ø§Ù„Ù†Øµ
        // ------------------------------------------------

        async function summarizeText() {
            const textToSummarize = userInput.value.trim();
            
            if (textToSummarize.length < 50 || isLoading) {
                const errorMsg = textToSummarize.length < 50 ? 
                                     'Ø¹Ø°Ø±Ø§Ù‹ØŒ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø±Ø§Ø¯ ØªÙ„Ø®ÙŠØµÙ‡ Ø£Ø·ÙˆÙ„ Ù…Ù† 50 Ø­Ø±ÙØ§Ù‹. ÙŠØ±Ø¬Ù‰ Ù„ØµÙ‚ Ù†Øµ Ø·ÙˆÙŠÙ„.' :
                                     'Ø§Ù„Ù†Ø¸Ø§Ù… Ù…Ø´ØºÙˆÙ„ Ø­Ø§Ù„ÙŠØ§Ù‹ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±.';
                                     
                addMessageToUI('model', errorMsg, 'summary_response');
                return;
            }

            // 1. Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø¯Ø®Ù„
            addMessageToUI('user', textToSummarize, 'summary_request');
            
            // Ù…Ø³Ø­ Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø¬Ù…Ù‡
            userInput.value = '';
            resizeInput();
            
            // 2. ØªÙØ¹ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø©
            setLoading(true, 'Rsbalo-Ø±Ø³Ø¨Ø§Ù„Ùˆ ÙŠÙ„Ø®Øµ...');
            showTypingIndicator();


            // Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªÙ„Ø®ÙŠØµ ÙƒØ§Ø³ØªØ¹Ù„Ø§Ù… Ø¬Ø¯ÙŠØ¯
            const userQuery = `Ù„Ø®Ù‘Øµ Ø§Ù„Ù†Øµ Ø§Ù„ØªØ§Ù„ÙŠ ÙÙŠ ÙÙ‚Ø±Ø© ÙˆØ§Ø­Ø¯Ø© (Ù…Ø§ Ù„Ø§ ÙŠØ²ÙŠØ¯ Ø¹Ù† 150 ÙƒÙ„Ù…Ø©) ÙˆØ­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ù„ÙˆØ¨ Ø§Ù„Ø±Ø³Ù…ÙŠ. Ø§Ù„Ù†Øµ: ${textToSummarize}`;
            
            const payload = {
                // Ù†Ø±Ø³Ù„ Ø±Ø³Ø§Ù„Ø© ÙˆØ§Ø­Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„ØªÙ„Ø®ÙŠØµ
                contents: [{ role: "user", parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: "Ø£Ù†Øª Ø®Ø¨ÙŠØ± ÙÙŠ Ø§Ù„ØªÙ„Ø®ÙŠØµØŒ ÙˆÙ…Ù‡Ù…ØªÙƒ Ù‡ÙŠ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø£Ù‡Ù… Ø§Ù„Ù†Ù‚Ø§Ø· ÙÙŠ Ø£ÙŠ Ù†Øµ ÙŠÙ‚Ø¯Ù… Ø¥Ù„ÙŠÙƒ Ø¨Ø¯Ù‚Ø© ÙˆØ¥ÙŠØ¬Ø§Ø²ØŒ Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ù„ØºØ© Ø§Ù„Ù†Øµ Ø§Ù„Ø£ØµÙ„ÙŠØ©." }]
                },
                // Ù„Ø§ Ù†Ø­ØªØ§Ø¬ Ù„Ø£Ø¯Ø§Ø© Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ØªÙ„Ø®ÙŠØµ
            };

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            try {
                const response = await exponentialBackoffFetch(chatApiUrl, options);
                const result = await response.json();

                if (result.candidates && result.candidates.length > 0) {
                    const aiResponseText = result.candidates[0].content?.parts?.[0]?.text;

                    if (aiResponseText) {
                        addMessageToUI('model', aiResponseText, 'summary_response');
                    } else {
                        addMessageToUI('model', 'Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ù… Ø£ØªÙ…ÙƒÙ† Ù…Ù† ØªÙˆÙ„ÙŠØ¯ Ù…Ù„Ø®Øµ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù†Øµ.', 'summary_response');
                    }
                } else {
                    const errorMessage = result.error?.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø®Ø¯Ù…Ø© Ø§Ù„ØªÙ„Ø®ÙŠØµ.';
                    addMessageToUI('model', `Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ„Ø®ÙŠØµ: ${errorMessage}`, 'summary_response');
                }

            } catch (error) {
                console.error('Gemini Summarization API Error:', error);
                addMessageToUI('model', `Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ© Ø£Ùˆ Ø§Ù„Ù€ API Ù„Ù„ØªÙ„Ø®ÙŠØµ. (Ø§Ù„ØªÙØ§ØµÙŠÙ„: ${error.message})`, 'summary_response');
            } finally {
                // 3. Ø¥Ø®ÙØ§Ø¡ Ù…Ø¤Ø´Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙˆØ­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
                hideTypingIndicator();
                setLoading(false);
            }
        }


        // ------------------------------------------------
        // ÙˆØ¸ÙŠÙØ© Ø¥Ù†Ø´Ø§Ø¡ Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± 
        // ------------------------------------------------
        async function generateQuizQuestions() {
            const textForQuiz = userInput.value.trim();
            
            if (textForQuiz.length < 100 || isLoading) {
                const errorMsg = textForQuiz.length < 100 ? 
                                     'Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø£Ø³Ø¦Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø± Ù…ÙÙŠØ¯Ø©ØŒ ÙŠØ±Ø¬Ù‰ Ù„ØµÙ‚ Ù†Øµ Ø¯Ø±Ø§Ø³ÙŠ Ù„Ø§ ÙŠÙ‚Ù„ Ø¹Ù† 100 Ø­Ø±Ù.' :
                                     'Ø§Ù„Ù†Ø¸Ø§Ù… Ù…Ø´ØºÙˆÙ„ Ø­Ø§Ù„ÙŠØ§Ù‹ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±.';
                                     
                addMessageToUI('model', errorMsg, 'quiz_response');
                return;
            }

            // 1. Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø¯Ø®Ù„
            addMessageToUI('user', textForQuiz, 'quiz_request');
            
            // Ù…Ø³Ø­ Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø¬Ù…Ù‡
            userInput.value = '';
            resizeInput();
            
            // 2. ØªÙØ¹ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø©
            setLoading(true, 'Rsbalo-Ø±Ø³Ø¨Ø§Ù„Ùˆ ÙŠÙÙ†Ø´Ø¦ Ø§Ø®ØªØ¨Ø§Ø±Ø§Ù‹...');
            showTypingIndicator();


            // Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙƒØ§Ø³ØªØ¹Ù„Ø§Ù… Ø¬Ø¯ÙŠØ¯
            const userQuery = `Ù…Ù† Ø§Ù„Ù†Øµ Ø§Ù„ØªØ§Ù„ÙŠØŒ Ù‚Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¡ 3 Ø£Ø³Ø¦Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø± Ù…ØªÙ†ÙˆØ¹Ø© (Ø³Ø¤Ø§Ù„ ÙˆØ§Ø­Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯ØŒ Ø³Ø¤Ø§Ù„ ÙˆØ§Ø­Ø¯ ØµÙˆØ§Ø¨/Ø®Ø·Ø£ØŒ ÙˆØ³Ø¤Ø§Ù„ ÙˆØ§Ø­Ø¯ Ø¥Ø¬Ø§Ø¨Ø© Ù‚ØµÙŠØ±Ø©). ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù…Ø¨Ø§Ø´Ø±Ø© ÙˆØªØ®ØªØ¨Ø± Ø§Ù„ÙÙ‡Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù„Ù„Ù…Ø§Ø¯Ø©. Ø¶Ø¹ ÙƒÙ„ Ø³Ø¤Ø§Ù„ ÙˆØ¥Ø¬Ø§Ø¨ØªÙ‡ ÙÙŠ ØªÙ†Ø³ÙŠÙ‚ Markdown Ø³Ù‡Ù„ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©. Ø§Ù„Ù†Øµ: ${textForQuiz}`;
            
            const payload = {
                contents: [{ role: "user", parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: "Ø£Ù†Øª Ø®Ø¨ÙŠØ± ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ©. Ù‚Ù… Ø¨ØªÙˆÙ„ÙŠØ¯ 3 Ø£Ø³Ø¦Ù„Ø© Ù…ØªÙ†ÙˆØ¹Ø© (MCQØŒ True/FalseØŒ Short Answer) Ù…Ø¹ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ÙŠØ© Ù„ÙƒÙ„ Ø³Ø¤Ø§Ù„ØŒ Ø§Ø¹ØªÙ…Ø§Ø¯Ø§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù†Øµ Ø§Ù„Ù…ÙØ¯Ø®Ù„. Ø§Ø³ØªØ®Ø¯Ù… ØªÙ†Ø³ÙŠÙ‚ Markdown ÙˆØ§Ø¶Ø­ (Ù‚ÙˆØ§Ø¦Ù… Ù…Ø±Ù‚Ù…Ø©ØŒ Ø®Ø· ØºÙ„ÙŠØ¸) ÙˆÙ„Ø§ ØªØªØ¬Ø§ÙˆØ² Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©." }]
                },
            };

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            try {
                const response = await exponentialBackoffFetch(chatApiUrl, options);
                const result = await response.json();

                if (result.candidates && result.candidates.length > 0) {
                    const aiResponseText = result.candidates[0].content?.parts?.[0]?.text;

                    if (aiResponseText) {
                        addMessageToUI('model', aiResponseText, 'quiz_response');
                    } else {
                        addMessageToUI('model', 'Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ù… Ø£ØªÙ…ÙƒÙ† Ù…Ù† Ø¥Ù†Ø´Ø§Ø¡ Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù†Øµ.', 'quiz_response');
                    }
                } else {
                    const errorMessage = result.error?.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø®Ø¯Ù…Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±.';
                    addMessageToUI('model', `Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: ${errorMessage}`, 'quiz_response');
                }

            } catch (error) {
                console.error('Gemini Quiz API Error:', error);
                addMessageToUI('model', `Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ© Ø£Ùˆ Ø§Ù„Ù€ API Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±. (Ø§Ù„ØªÙØ§ØµÙŠÙ„: ${error.message})`, 'quiz_response');
            } finally {
                 // 3. Ø¥Ø®ÙØ§Ø¡ Ù…Ø¤Ø´Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙˆØ­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
                hideTypingIndicator();
                setLoading(false);
            }
        }

        // ------------------------------------------------
        // ÙˆØ¸Ø§Ø¦Ù Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© (Ø§Ù„Ø²Ø± Ø§Ù„Ù…Ø·ÙˆØ±)
        // ------------------------------------------------

        /**
         * ØªØ¨Ø¯ÙŠÙ„ Ø¥Ø¸Ù‡Ø§Ø± ÙˆØ¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ù„Ù„Ø£Ø¯ÙˆØ§Øª.
         */
        function toggleToolsMenu() {
            toolsMenu.classList.toggle('hidden');
            // Ø¥Ø°Ø§ Ø¸Ù‡Ø±Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©ØŒ Ù†Ø±Ø§Ù‚Ø¨ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§ Ù„Ø¥Ø®ÙØ§Ø¦Ù‡Ø§
            if (!toolsMenu.classList.contains('hidden')) {
                document.addEventListener('click', handleOutsideClick);
            } else {
                document.removeEventListener('click', handleOutsideClick);
            }
        }

        /**
         * Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§.
         */
        function handleOutsideClick(event) {
            const container = document.getElementById('tools-dropdown-container');
            // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù†Ù‚Ø± Ù„Ù… ÙŠÙƒÙ† Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø£Ùˆ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
            if (!container.contains(event.target)) {
                toolsMenu.classList.add('hidden');
                document.removeEventListener('click', handleOutsideClick);
            }
        }

        // ------------------------------------------------
        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
        // ------------------------------------------------
        
        // Ø±Ø¨Ø· Ø²Ø± ØªØ¨Ø¯ÙŠÙ„ Ù…ÙØªØ§Ø­ API
        apiKeyToggle.addEventListener('click', toggleApiKeyInput);
        
        // Ø±Ø¨Ø· Ø²Ø± Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø¬Ø¯ÙŠØ¯
        saveApiKeyButton.addEventListener('click', saveApiKey);

        // Ø±Ø¨Ø· Ø²Ø± Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¨ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        toolsToggleButton.addEventListener('click', (e) => {
            e.stopPropagation(); // Ù…Ù†Ø¹ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙÙˆØ±Ø§Ù‹ Ø¨Ø³Ø¨Ø¨ event bubbling
            toggleToolsMenu();
        });

        // Ø±Ø¨Ø· Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø§Ù„ÙˆØ¸Ø§Ø¦Ù
        summarizeOption.addEventListener('click', () => {
            toolsMenu.classList.add('hidden'); // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
            summarizeText();
        });

        quizOption.addEventListener('click', () => {
            toolsMenu.classList.add('hidden'); // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
            generateQuizQuestions();
        });

        // Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± (Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©)
        sendButton.addEventListener('click', sendMessage);
        
        // Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter (Ù„Ù„Ø¯Ø±Ø¯Ø´Ø© ÙÙ‚Ø·)
        userInput.addEventListener('keypress', function(e) {
            // ÙŠØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø°Ø§ Ø¶ØºØ· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù„Ù‰ Enter ÙˆÙ„Ù… ÙŠØ¶ØºØ· Shift (Ø¹Ø§Ø¯Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯)
            if (e.key === 'Enter' && !e.shiftKey && !isLoading) {
                e.preventDefault(); // Ù…Ù†Ø¹ Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯
                sendMessage();
            }
        });
        
        // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø§Ù„Ø£ÙˆÙ„ÙŠ ÙˆØªØ­Ø¯ÙŠØ¯ Ø­Ø¬Ù… Ø§Ù„Ø­Ù‚Ù„ ÙˆØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙØªØ§Ø­
        window.onload = () => {
            loadApiKey(); // ØªØ­Ù…ÙŠÙ„ Ù…ÙØªØ§Ø­ Ø§Ù„Ù€ API Ø§Ù„Ù…Ø­ÙÙˆØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹
            userInput.focus();
            resizeInput(); // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø­Ø¬Ù… ØµØ­ÙŠØ­ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
             // ØªÙØ¹ÙŠÙ„ Ø®Ø§ØµÙŠØ© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØµØ­ÙŠØ­ ÙÙŠ Ø¨ÙŠØ¦Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ØŒ ÙÙŠ Ø­Ø§Ù„ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
            if (typeof setLogLevel === 'function') {
                setLogLevel('Debug');
            }
             // ØªØ­Ø¯ÙŠØ« Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ ÙÙŠ Ø­Ø§Ù„ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø© Ù„ØªØ¸Ù‡Ø± Ø²Ø± TTS
             const initialWelcomeMessageContent = document.querySelector('.ai-message-row .message-content .message-content-text');
             if (initialWelcomeMessageContent) {
                 const text = initialWelcomeMessageContent.textContent;
                 const ttsButtonContainer = createTTSButton(text);
                 initialWelcomeMessageContent.parentNode.appendChild(ttsButtonContainer);
                 
                 // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
                 const ttsButton = ttsButtonContainer.querySelector('#tts-play-button');
                 if (ttsButton) ttsButton.disabled = false;
             }
        };

    </script>
</body>
</html>
