<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الرانيك - محادثات أدبية</title>
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Markdown-it library for parsing Markdown to HTML -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it/dist/markdown-it.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it-footnote/dist/markdown-it-footnote.min.js"></script>

    <!-- CSS for ultra-modern, high-contrast, developed chat styling -->
    <style>
        :root {
            --bg-main: #F9FAFB; /* خلفية ناعمة جداً */
            --bg-ai-container: #FFFFFF; /* خلفية رسائل الرانيك (واضحة) */
            --bg-input: #FFFFFF; /* خلفية شريط الإدخال */
            --text-color: #111827; /* نص داكن جداً لقراءة فائقة */
            --accent-color: #10B981; /* لون بحري متطور */
            --accent-hover: #059669;
            --icon-size: 35px;
            --radius-main: 12px;
        }

        /* خط نظيف وعصري يدعم العربية بوضوح */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', 'Segoe UI', Tahoma, Arial, sans-serif;
            transition: all 0.2s ease-in-out;
        }

        body {
            background-color: var(--bg-main);
            color: var(--text-color);
            direction: rtl;
            text-align: right;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .chat-container { flex-grow: 1; display: flex; flex-direction: column; width: 100%; }
        .main-chat-area { flex-grow: 1; display: flex; flex-direction: column; position: relative; }
        
        .chat-header {
            padding: 20px;
            text-align: center;
            background-color: var(--bg-main);
            color: var(--text-color);
            font-size: 1.6rem;
            font-weight: 700;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); 
            position: sticky;
            top: 0;
            z-index: 20;
        }

        .messages-display {
            flex-grow: 1;
            overflow-y: auto;
            padding-bottom: 150px;
            padding-top: 10px;
            max-width: 800px;
            margin: 0 auto; 
            width: 100%;
        }

        .message { 
            display: flex; 
            align-items: flex-start;
            padding: 20px 0; 
            border-top: 1px solid #E5E7EB; /* خط فاصل خفيف جداً */
            margin-bottom: 0;
            padding-left: 20px;
            padding-right: 20px;
        }
        
        /* AI Message Container */
        .ai-message {
            background-color: var(--bg-ai-container);
            border-bottom: 1px solid #E5E7EB;
        }

        /* User Message Container */
        .user-message {
            background-color: var(--bg-main); /* لون الخلفية الرئيسي */
            color: var(--text-color);
            border-bottom: 1px solid #E5E7EB;
        }

        .message-icon {
            width: var(--icon-size);
            height: var(--icon-size);
            border-radius: 8px; /* مربع ناعم بدلاً من دائرة */
            background: var(--text-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #FFFFFF;
            font-size: 18px;
            flex-shrink: 0;
            margin-left: 20px;
        }

        .user-message .message-icon { 
            background: var(--accent-color);
        }

        .message-content {
            flex-grow: 1;
            padding-left: 10px;
            line-height: 1.7;
            font-size: 1.05rem; /* حجم خط مريح ومطور */
            word-wrap: break-word;
        }
        
        .message-content p {
            margin-bottom: 1em;
            text-align: justify;
        }
        
        /* Table Styling - Clean and Highly Legible */
        .message-content table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 25px;
            color: var(--text-color);
            border-radius: var(--radius-main);
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid #E5E7EB;
        }
        .message-content th, .message-content td {
            padding: 14px 18px;
            text-align: right;
            border: 1px solid #F3F4F6; /* خطوط داخلية أفتح */
        }
        .message-content th {
            background-color: var(--accent-color);
            color: #FFFFFF;
            font-weight: 700;
            font-size: 1rem;
        }
        .message-content tr:nth-child(even) {
            background-color: #F9FAFB;
        }
        .message-content tr:hover td {
            background-color: #EFF6FF;
        }

        /* Input Area - Floating and Central */
        .input-area-wrapper {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: linear-gradient(to top, var(--bg-main) 90%, rgba(249, 250, 251, 0.8) 100%);
            /* تم التعديل: إضافة هامش أفقي لضمان المسافة على حواف الشاشة */
            padding: 15px 20px 25px 20px; 
            z-index: 100;
        }

        .feature-controls {
            max-width: 800px;
            margin: 0 auto;
            text-align: right;
            padding-bottom: 10px;
            /* تم التعديل: إزالة الهوامش الأفقية المتعارضة */
        }

        #image-btn {
            background-color: #6B7280;
            color: #FFFFFF;
            border: none;
            padding: 8px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s, transform 0.1s;
        }
        #image-btn:hover { background-color: #4B5563; }

        .input-area {
            display: flex;
            max-width: 800px;
            margin: 0 auto; /* هذا يضمن التوسيط */
            padding: 10px;
            background-color: var(--bg-input);
            border-radius: var(--radius-main);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); 
            align-items: flex-end; 
            border: 1px solid #D1D5DB;
            /* تم التعديل: إزالة الهوامش الأفقية المتعارضة */
        }

        #user-input {
            flex-grow: 1;
            background-color: transparent;
            border: none;
            color: var(--text-color);
            resize: none;
            font-size: 1.1rem;
            padding: 5px 10px;
            min-height: 25px; 
            max-height: 150px; 
            overflow-y: auto;
            line-height: 1.5;
            direction: rtl;
            text-align: right;
        }
        #user-input:focus { outline: none; }

        #send-btn {
            background-color: var(--accent-color);
            color: #FFFFFF;
            border: none;
            width: 38px;
            height: 38px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s, transform 0.1s;
        }

        #send-btn:hover { background-color: var(--accent-hover); }
        #send-btn:active { transform: scale(0.95); }

        .disclaimer {
            text-align: center;
            font-size: 0.75rem;
            color: #9CA3AF;
            margin-top: 10px;
        }

        /* Typing Indicator - Three Dots as requested */
        .typing-indicator-wrapper {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            background-color: #FFFFFF;
            border-bottom: 1px solid #E5E7EB;
            min-height: 75px; /* ensure height matches standard message */
        }
        .typing-indicator-dots {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-right: 15px;
        }
        .typing-indicator {
            width: 8px;
            height: 8px;
            background-color: #6B7280;
            border-radius: 50%;
            animation: dot-bounce 1.4s infinite ease-in-out both;
        }
        .typing-indicator:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator:nth-child(3) { animation-delay: 0.4s; }

        @keyframes dot-bounce {
            0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
            40% { transform: scale(1.0); opacity: 1; }
        }

        /* AI Features Button (TTS) */
        .ai-feature-buttons {
            margin-top: 15px;
            display: flex;
            gap: 5px;
        }
        .tts-button {
            background-color: #F3F4F6;
            color: var(--text-color);
            border: 1px solid #E5E7EB;
            padding: 5px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background-color 0.2s;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        .tts-button:hover { background-color: #E5E7EB; }

        /* Image Generation Styles */
        .image-container {
            margin-top: 20px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: 1px solid #D1D5DB;
        }
        .image-container img { width: 100%; height: auto; display: block; }
        .loading-image {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: #FFFFFF;
            height: 300px;
            border-radius: 12px;
            color: var(--accent-color);
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        /* Mobile Adjustments - Removed conflicting margins */
        @media (max-width: 600px) {
            .message { padding-left: 10px; padding-right: 10px; }
            .message-icon { margin-left: 10px; }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="main-chat-area">
            <div class="chat-header">
                <h2>🖋️ الرانيك</h2>
            </div>
            
            <div class="messages-display" id="messages-display">
                <!-- Initial Welcome Message - Updated -->
                <div class="message ai-message">
                    <div class="message-icon"><i class="fas fa-hat-wizard"></i></div>
                    <div class="message-content">
                        <p>أهلاً بك أيها الكاتب المبدع! أنا **الرانيك**، النموذج المتطور للرواية والتحليل التاريخي.</p>
                        <p>أنا هنا لأجيب على أي استفسار أدبي أو تاريخي بتفاصيل دقيقة وواقعية. تفضل بما تجول به أفكارك وسأقوم بتفصيلها فوراً.</p>
                        <div class="ai-feature-buttons">
                            <button class="tts-button" onclick="textToSpeech(this)">
                                <i class="fas fa-volume-up"></i> قراءة
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="input-area-wrapper">
                <div class="feature-controls">
                    <button id="image-btn" onclick="promptForImage()" title="توليد صورة للمشهد">
                        <i class="fas fa-magic"></i> توليد صورة للمشهد
                    </button>
                </div>
                <div class="input-area">
                    <textarea id="user-input" placeholder="اكتب طلبك الأدبي أو تفاصيل روايتك المفضلة هنا..." rows="1"></textarea>
                    <button id="send-btn" onclick="sendMessage()">
                        <i class="fas fa-arrow-up"></i>
                    </button>
                </div>
                <p class="disclaimer">هذا النظام يتصل بنموذج ذكاء اصطناعي حقيقي لإنشاء محتوى إبداعي.</p>
            </div>
        </div>
    </div>
    
    <!-- JavaScript for API calls and chat logic -->
    <script>
        // API key and URL for the Gemini model
        const apiKey = "AIzaSyCN7xfp3Jzsb9CzQWzk9Tiyi-RfbSDiAUg";
        const textApiUrl = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=" + apiKey;
        const ttsApiUrl = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=" + apiKey;
        // API for image generation (Imagen 3.0)
        const imageApiUrl = "https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=" + apiKey;

        const md = window.markdownit();

        let chatHistory = [];

        // ******** النظام الأساسي للرانيك - قواعد ثابتة لا تتغير ********
        const systemPrompt = "أنت الرانيك، روائي عبقري ومؤرخ دقيق. مهمتك هي كتابة روايات وسيناريوهات غاية في الواقعية والتفصيل، مع التركيز على الدقة التاريخية المطلقة. **اللغة الأساسية والوحيدة للردود هي العربية الفصحى، التزم بها التزاماً مطلقاً ولا تستخدم أي لغة أخرى بما في ذلك الإنجليزية، حتى عند التعامل مع مصطلحات أجنبية. ردودك يجب أن تكون فورية وسريعة جداً. لا تتأخر في الرد أبداً.** عندما يُطلب منك وصف حدث تاريخي، مثل حرب، أن يكون سردك مطابقاً للحقيقة تماماً، بما في ذلك التفاصيل الدقيقة مثل المعدات العسكرية، الصفقات، أو حتى تحركات الجيوش. يجب أن تكون ذكياً جداً ومتفهماً لكل طلب، وأن تستطيع استنتاج التفاصيل الواقعية حتى لو لم يذكرها المستخدم صراحة. استخدم أسلوباً فخماً ومتقناً في كل كتاباتك. **الالتزام المطلق للجدول:** عندما يُطلب منك أي **مقارنة**، أو **تصنيف**، أو عرض **خسائر**، يجب عليك **فوراً** استخدام جدول Markdown. **أمر صارم حول محتوى الجدول:** يجب أن تكون كل خلية في الجدول تحتوي على القيمة الحقيقية والمحددة **فقط**، دون أي وصف أو إطالة. **يجب أن تكون البيانات واقعية جداً، وتفصيلية، ومطابقة مباشرة لاسم العمود/الصف (مثل: 75 كم/س، 120 مم، 8000 جندي). لا تترك خانة فارغة أبداً.** يجب استخدام معدات عسكرية حقيقية ومعاصرة (مثل F-35، T-90، إلخ) وتفاصيل واقعية ومحددة (مثل مدى، سرعة، حمولة). **افصل كل نقطة مقارنة في سطر منفصل وواضح**، مثل: 'القوة البشرية', 'القوات العاملة', 'القوات الاحتياطية', 'الميزانية الدفاعية', 'القوات البرية', 'القوات الجوية', 'القوات البحرية', و'القدرات التكنولوجية'. هذا يضمن أعلى مستوى من الدقة والذكاء في العرض.";
        // *************************************************************

        async function sendMessage() {
            const inputField = document.getElementById('user-input');
            const sendBtn = document.getElementById('send-btn');
            const userPrompt = inputField.value.trim();

            if (userPrompt === "") return;

            // Display user message
            addMessage(userPrompt, false);
            inputField.value = '';
            inputField.style.height = '25px';

            // Show typing indicator (three dots)
            const typingIndicatorMessage = addMessage(
                '<div class="typing-indicator-dots"><div class="typing-indicator"></div><div class="typing-indicator"></div><div class="typing-indicator"></div></div>', 
                true,
                true // Skip features (TTS) for loading message
            );
            sendBtn.disabled = true;
            inputField.disabled = true;
            document.getElementById('image-btn').disabled = true;

            // Add the user's message to the chat history
            chatHistory.push({ role: "user", parts: [{ text: userPrompt }] });

            const payload = {
                contents: chatHistory,
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };
            
            try {
                // Send the request to the Gemini API
                const response = await fetch(textApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                    const aiResponse = result.candidates[0].content.parts[0].text;
                    
                    // Remove the typing indicator and add the AI's response
                    typingIndicatorMessage.remove();
                    addMessage(aiResponse, true); // Pass raw response to be handled by addMessage
                    chatHistory.push({ role: "model", parts: [{ text: aiResponse }] });
                } else {
                    typingIndicatorMessage.remove();
                    addMessage("عذراً، لم يتمكن الرانيك من إرسال رد. يرجى المحاولة مرة أخرى.", true);
                }

            } catch (error) {
                console.error('Error fetching AI response:', error);
                typingIndicatorMessage.remove();
                addMessage("حدث خطأ في الاتصال بالرانيك. يرجى المحاولة مرة أخرى.", true);
            } finally {
                // Re-enable input and button regardless of success or failure
                sendBtn.disabled = false;
                inputField.disabled = false;
                document.getElementById('image-btn').disabled = false;
            }
        }

        /**
         * Converts base64 encoded PCM audio data to a WAV Blob.
         */
        function pcmToWav(base64Data, sampleRate) {
            const audioData = atob(base64Data);
            const pcmData = new Int16Array(audioData.length / 2);

            for (let i = 0; i < audioData.length / 2; i++) {
                const byte1 = audioData.charCodeAt(2 * i);
                const byte2 = audioData.charCodeAt(2 * i + 1);
                pcmData[i] = (byte2 << 8) | byte1;
            }
            
            const numChannels = 1;
            const bitsPerSample = 16;
            const blockAlign = numChannels * (bitsPerSample / 8);
            const byteRate = sampleRate * blockAlign;
            const dataSize = pcmData.length * (bitsPerSample / 8);

            const buffer = new ArrayBuffer(44 + dataSize);
            const view = new DataView(buffer);

            // WAV header
            let offset = 0;
            const writeString = (str) => {
                for (let i = 0; i < str.length; i++) view.setUint8(offset + i, str.charCodeAt(i));
                offset += str.length;
            };

            writeString('RIFF'); 
            view.setUint32(offset, 36 + dataSize, true); 
            offset += 4;
            writeString('WAVE'); 
            writeString('fmt '); 
            view.setUint32(offset, 16, true); 
            offset += 4;
            view.setUint16(offset, 1, true); 
            offset += 2;
            view.setUint16(offset, numChannels, true); 
            offset += 2;
            view.setUint32(offset, sampleRate, true); 
            offset += 4;
            view.setUint32(offset, byteRate, true); 
            offset += 4;
            view.setUint16(offset, blockAlign, true); 
            offset += 2;
            view.setUint16(offset, bitsPerSample, true); 
            offset += 2;
            writeString('data'); 
            view.setUint32(offset, dataSize, true); 
            offset += 4;

            // Write PCM data
            for (let i = 0; i < pcmData.length; i++) {
                view.setInt16(offset, pcmData[i], true);
                offset += 2;
            }

            return new Blob([view], { type: 'audio/wav' });
        }

        async function textToSpeech(button) {
            const messageContentElement = button.closest('.message-content');
            let messageContent = messageContentElement.textContent.trim();
            
            const featureButtons = messageContentElement.querySelector('.ai-feature-buttons');
            if (featureButtons) {
                const tempClone = messageContentElement.cloneNode(true);
                tempClone.querySelector('.ai-feature-buttons')?.remove();
                messageContent = tempClone.textContent.trim();
            }

            if (!messageContent) return;

            button.disabled = true;
            const icon = button.querySelector('i');
            icon.classList.remove('fa-volume-up');
            icon.classList.add('fa-spinner', 'fa-spin');

            const payload = {
                contents: [{
                    parts: [{ text: messageContent }]
                }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: "Kore" }
                        }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };

            try {
                const response = await fetch(ttsApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                    const sampleRate = parseInt(mimeType.match(/rate=(\d+)/)[1], 10);
                    const wavBlob = pcmToWav(audioData, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    const audio = new Audio(audioUrl);
                    audio.play();
                } else {
                    console.error("Invalid audio data received.");
                }
            } catch (error) {
                console.error('Error with TTS:', error);
            } finally {
                icon.classList.remove('fa-spinner', 'fa-spin');
                icon.classList.add('fa-volume-up');
                button.disabled = false;
            }
        }

        async function generateImage(userPrompt) {
            const enhancedPrompt = userPrompt + ", cinematic, highly detailed, fantasy digital painting, 4k";

            const payload = { 
                instances: [{ prompt: enhancedPrompt }],
                parameters: { "sampleCount": 1 } 
            };
            
            let attempts = 0;
            const maxAttempts = 5;
            let delay = 1000; 

            while (attempts < maxAttempts) {
                try {
                    const response = await fetch(imageApiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429) { 
                        attempts++;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; 
                        continue;
                    }

                    const result = await response.json();
                    if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                        return `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                    } else {
                        console.error("Image generation failed with no base64 data:", result);
                        return null;
                    }
                } catch (error) {
                    attempts++;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                    if (attempts >= maxAttempts) throw error; 
                }
            }
            return null;
        }

        async function promptForImage() {
            const prompt = window.prompt("ما هو المشهد الذي تريد أن يرسمه الرانيك؟ (مثال: سفينة فضاء تحلق فوق كوكب أحمر في عاصفة رملية، فن رقمي)");
            if (!prompt || prompt.trim() === "") return;

            addMessage(`طلب صورة: ${prompt}`, false);

            const loadingMessage = addMessage(
                '<div class="typing-indicator-dots"><i class="fas fa-palette fa-spin" style="margin-left: 10px; color: var(--accent-color);"></i></div>',
                true,
                true
            );
            
            const sendBtn = document.getElementById('send-btn');
            const inputField = document.getElementById('user-input');
            const imageBtn = document.getElementById('image-btn');
            sendBtn.disabled = true;
            inputField.disabled = true;
            imageBtn.disabled = true;

            try {
                const imageUrl = await generateImage(prompt);
                
                loadingMessage.remove();

                if (imageUrl) {
                    addMessage(`<p>رسم الرانيك هذا المشهد بناءً على طلبك:</p><div class="image-container"><img src="${imageUrl}" alt="${prompt}"></div>`, true);
                } else {
                    addMessage("عذراً، لم يتمكن الرانيك من توليد الصورة المطلوبة. يرجى محاولة وصف آخر.", true);
                }

            } catch (error) {
                console.error("Error generating image:", error);
                loadingMessage.remove();
                addMessage("حدث خطأ أثناء توليد الصورة. يرجى المحاولة مرة أخرى.", true);
            } finally {
                sendBtn.disabled = false;
                inputField.disabled = false;
                imageBtn.disabled = false;
            }
        }
        
        // Function to add messages to the chat display
        function addMessage(content, isAI, skipFeatures = false) {
            const display = document.getElementById('messages-display');
            const messageDiv = document.createElement('div');
            
            if (isAI && content.includes('typing-indicator-dots')) {
                // Special handling for the typing indicator
                messageDiv.className = `message ai-message typing-indicator-wrapper`;
                
                const iconDiv = document.createElement('div');
                iconDiv.className = 'message-icon';
                iconDiv.innerHTML = '<i class="fas fa-hat-wizard"></i>';

                const contentDiv = document.createElement('div');
                contentDiv.innerHTML = content;
                
                messageDiv.appendChild(iconDiv);
                messageDiv.appendChild(contentDiv);
            } else {
                // Standard message bubble
                messageDiv.className = `message ${isAI ? 'ai-message' : 'user-message'}`;

                const iconDiv = document.createElement('div');
                iconDiv.className = 'message-icon';
                iconDiv.innerHTML = isAI ? '<i class="fas fa-hat-wizard"></i>' : '<i class="fas fa-user-circle"></i>';

                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                
                // 1. Process Content (Markdown rendering)
                const processedContent = isAI && !skipFeatures ? md.render(content) : content;
                contentDiv.innerHTML = processedContent; // <-- تم التغيير: نضع المحتوى النظيف مباشرة

                // 2. Add TTS button to AI messages, unless skipped (appended after content)
                if (isAI && !skipFeatures) { 
                    const buttonContainer = document.createElement('div');
                    buttonContainer.className = 'ai-feature-buttons';
                    const ttsButton = document.createElement('button');
                    ttsButton.className = 'tts-button';
                    ttsButton.innerHTML = '<i class="fas fa-volume-up"></i> قراءة';
                    ttsButton.onclick = () => textToSpeech(ttsButton);
                    buttonContainer.appendChild(ttsButton);
                    
                    // Append the buttons after the content has been set
                    contentDiv.appendChild(buttonContainer);
                }
                
                messageDiv.appendChild(iconDiv);
                messageDiv.appendChild(contentDiv);
            }

            display.appendChild(messageDiv);
            display.scrollTop = display.scrollHeight;
            return messageDiv;
        }

        document.getElementById('user-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); 
                sendMessage();
            }
        });

        document.getElementById('user-input').addEventListener('input', function() {
            this.style.height = 'auto'; 
            this.style.height = (this.scrollHeight) + 'px'; 
        });
        
        window.onload = function() {
            const inputField = document.getElementById('user-input');
            inputField.style.height = '25px';
        };
    </script>
</body>
</html>
